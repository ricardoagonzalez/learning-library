
# Omit the Column Encryption Attribute During Import

## Introduction
In the Oracle Public Cloud environment, data is encrypted by default using Transparent Data Encryption (TDE) and the encrypted tablespace feature, but not the encrypted column feature. If an exported table holds encrypted columns, there must be a method to import the table and suppress the encryption clause associated with the table creation during the import operation.

In this lab, you use the Oracle Data Pump Import utility (impdp) to simulate an import into a PDB, once with the `ENCRYPT` attribute, and once without it. Use the `workshop-installed` compute instance.

Estimated Time: 5 minutes

### Objectives

In this lab, you will:

- Import a table with the `ENCRYPT` attribute
- Import a table without the `ENCRYPT` attribute
- Reset your environment

### Prerequisites

This lab assumes you have:
- Obtained and signed in to your `workshop-installed` compute instance.

## Task 1: Import a table with the `ENCRYPT` attribute

> **NOTE:** Unless otherwise stated, all passwords will be `Ora4U_1234`. When copying and pasting a command that includes a password, please replace the word `password` with `Ora4U_1234`. This only applies to instances created through OCI Resource Manager with our provided terraform scripts.

1. Open a terminal window on the desktop.

2. Switch to the `$HOME/labs/19cnf` directory.

    ```
    $ <copy>cd $HOME/labs/19cnf</copy>
    ```

3. Verify that `tab.dmp` exists in this directory. The `tab.dmp` file was generated by using the Oracle Data Pump Export utility. It has table data and database metadata and is written in a proprietary format.

    ```                
    $ <copy>ls tab.dmp</copy>

    tab.dmp
    ```

4. Set the Oracle environment variables. At the prompt, enter **CDB1**.

    ```
    $ <copy>. oraenv</copy>
    CDB1
    ```


5. Connect to PDB1 as the `SYSTEM` user.

    ```
    $ <copy>sqlplus system/password@PDB1</copy>
    ```

6. Create a directory called `dp` that points to the location of the dump file. Later, this directory is also used for storing generated log and SQL files.

    ```
    SQL> <copy>CREATE DIRECTORY dp AS '/home/oracle/labs/19cnf';</copy>

    Directory created.
    ```

7. Exit SQL*Plus.

    ```
    SQL> <copy>EXIT</copy>
    ```

8. Generate a SQL file from the Oracle Data Pump Export `tab.dmp` dump file by simulating an import into PDB1. By using the `SQLFILE` parameter, `impdp` simply generates the SQL DDL that the utility would otherwise execute without it. Please note the use of `password`.

    ```
    $ <copy>impdp SYSTEM/password@PDB1 DIRECTORY=dp DUMPFILE=tab.dmp SQLFILE=tabenc1 LOGFILE=enc.log</copy>

    Import: Release 19.0.0.0.0 - Production on Thu Aug 26 16:08:45 2021
    Version 19.12.0.0.0

    Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.

    Connected to: Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
    Master table "SYSTEM"."SYS_SQL_FILE_FULL_01" successfully loaded/unloaded
    Starting "SYSTEM"."SYS_SQL_FILE_FULL_01":  SYSTEM/********@PDB1 DIRECTORY=dp DUMPFILE=tab.dmp SQLFILE=tabenc1 LOGFILE=enc.log
    Processing object type TABLE_EXPORT/TABLE/TABLE
    Processing object type TABLE_EXPORT/TABLE/STATISTICS/TABLE_STATISTICS
    Processing object type TABLE_EXPORT/TABLE/STATISTICS/MARKER
    Job "SYSTEM"."SYS_SQL_FILE_FULL_01" successfully completed at Thu Aug 26 16:08:53 2021 elapsed 0 00:00:04
    ```

9.  View the `tabenc1.sql` file to verify that the `ENCRYPT` attribute is set on the `LABEL` column. Look for this line in the file: `"LABEL" VARCHAR2(50 BYTE) ENCRYPT USING 'AES192' 'SHA-1'`.

    ```
    $ <copy>cat tabenc1.sql</copy>

    -- CONNECT SYSTEM
    ALTER SESSION SET EVENTS '10150 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '10904 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '25475 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '10407 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '10851 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '22830 TRACE NAME CONTEXT FOREVER, LEVEL 192 ';
    -- new object type path: TABLE_EXPORT/TABLE/TABLE
    CREATE TABLE "TEST"."TABENC"
       (  "C1" NUMBER,
	    "LABEL" VARCHAR2(50 BYTE) ENCRYPT USING 'AES192' 'SHA-1'
       ) SEGMENT CREATION IMMEDIATE
      PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
     NOCOMPRESS LOGGING
      STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
      PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
      BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
      TABLESPACE "SYSTEM" ;
    -- new object type path: TABLE_EXPORT/TABLE/STATISTICS/TABLE_STATISTICS
    -- new object type path: TABLE_EXPORT/TABLE/STATISTICS/MARKER
    ```

## Task 2: Import the table without the `ENCRYPT` attribute

1. Generate the SQL file from the Oracle Data Pump Export `tab.dmp` dump file by simulating an import into PDB1. The following command removes the `ENCRYPT` clause by using `TRANSFORM=OMIT_ENCRYPTION_CLAUSE:Y`. You can also remap an unencrypted tablespace to an encrypted tablespace. In this step, we remap `system` to `test`. Please note the use of `password`.

    ```
    $ <copy>impdp SYSTEM/password@PDB1 DIRECTORY=dp DUMPFILE=tab.dmp SQLFILE=tabenc2 TRANSFORM=OMIT_ENCRYPTION_CLAUSE:Y REMAP_TABLESPACE=system:test LOGFILE=enc2.log</copy>

    Import: Release 19.0.0.0.0 - Production on Thu Aug 26 16:16:10 2021
    Version 19.12.0.0.0

    Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.

    Connected to: Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
    Master table "SYSTEM"."SYS_SQL_FILE_FULL_01" successfully loaded/unloaded
    Starting "SYSTEM"."SYS_SQL_FILE_FULL_01":  SYSTEM/********@PDB1 DIRECTORY=dp DUMPFILE=tab.dmp SQLFILE=tabenc2 TRANSFORM=OMIT_ENCRYPTION_CLAUSE:Y REMAP_TABLESPACE=system:test LOGFILE=enc2.log
    Processing object type TABLE_EXPORT/TABLE/TABLE
    Processing object type TABLE_EXPORT/TABLE/STATISTICS/TABLE_STATISTICS
    Processing object type TABLE_EXPORT/TABLE/STATISTICS/MARKER
    Job "SYSTEM"."SYS_SQL_FILE_FULL_01" successfully completed at Thu Aug 26 16:16:14 2021 elapsed 0 00:00:03
    ```

2. View the `tabenc2.sql` file to verify that the `ENCRYPT` attribute of the `LABEL` column in the `TEST.TABENC` table is not set. Look for this line in the file: `"LABEL" VARCHAR2(50 BYTE)`. Notice that the `ENCRYPT` attribute is not set on the `LABEL` column.

    ```
    $ <copy>cat tabenc2.sql</copy>

    -- CONNECT SYSTEM
    ALTER SESSION SET EVENTS '10150 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '10904 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '25475 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '10407 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '10851 TRACE NAME CONTEXT FOREVER, LEVEL 1';
    ALTER SESSION SET EVENTS '22830 TRACE NAME CONTEXT FOREVER, LEVEL 192 ';
    -- new object type path: TABLE_EXPORT/TABLE/TABLE
    CREATE TABLE "TEST"."TABENC"
       ("C1" NUMBER,
      "LABEL" VARCHAR2(50 BYTE)
       ) SEGMENT CREATION IMMEDIATE
      PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
     NOCOMPRESS LOGGING
      STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
      PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
      BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
      TABLESPACE "TEST" ;
    -- new object type path: TABLE_EXPORT/TABLE/STATISTICS/TABLE_STATISTICS
    -- new object type path: TABLE_EXPORT/TABLE/STATISTICS/MARKER
    ```

## Task 3: Reset your environment

1. Run the following  command to remove the files generated by the Oracle Data Pump Import utility. Be sure to execute the command exactly as it appears below or you may risk deleting SQL files critical to this workshop.

    ```
    $ <copy>rm tabenc*.sql enc*.log</copy>
    ```

2. Close the terminal window.

    ```
    $ <copy>exit</copy>
    ```



## Learn More

- [Database New Features Guide (Release 19c)](https://docs.oracle.com/en/database/oracle/oracle-database/19/newft/preface.html#GUID-E012DF0F-432D-4C03-A4C8-55420CB185F3)
- [Oracle Data Pump Import](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/datapump-import-utility.html#GUID-D11E340E-14C6-43B8-AB09-6335F0C1F71B)
- [Oracle Data Pump Export](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/oracle-data-pump-export-utility.html#GUID-5F7380CE-A619-4042-8D13-1F7DDE429991)
- [Using Oracle Data Pump with CDBs](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/oracle-data-pump-overview.html#GUID-BD76463C-0867-477E-983F-4329610EC458)

## Acknowledgements

- **Author**- Dominique Jeunot, Consulting User Assistance Developer
- **Contributor** - Jody Glover, Principal User Assistance Developer
- **Last Updated By/Date** - Matthew McDaniel, Austin Specialists Hub, September 21 2021
